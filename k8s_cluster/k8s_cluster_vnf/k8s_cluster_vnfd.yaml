# Copyright 2019 ETSI OSM
#
# All Rights Reserved.
#
#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.

vnfd:
  id: k8s_cluster_vnfd
  product-name: k8s_cluster_vnfd
  description: K8s cluster VNF
  provider: OSM
  version: '1.0'
  mgmt-cp: mgmt-ext
  int-virtual-link-desc:
  - id: internal-vld
  virtual-storage-desc:
  - id: k8s-controller-VM-storage
    size-of-storage: 32
  - id: k8s-worker-VM-storage
    size-of-storage: 64
  virtual-compute-desc:
  - id: k8s-controller-VM-compute
    virtual-cpu:
      num-virtual-cpu: 4
    virtual-memory:
      size: 4
  - id: k8s-worker-VM-compute
    virtual-cpu:
      num-virtual-cpu: 2
    virtual-memory:
      size: 2
  sw-image-desc:
  - id: "clean-ubuntu"
    name: "Ubuntu 20.04 x86_64"
    image: "Ubuntu 20.04 x86_64"
  - id: "ubuntu-template"
    name: "HAL_ubuntu2004_cloudinit_template"
    image: "HAL_ubuntu2004_cloudinit_template"
  df:
  - id: controller-df
    instantiation-level:
    - id: controller-instantiation-level
      vdu-level:
      - vdu-id: k8s-controller-VM
        number-of-instances: 1
    vdu-profile:
    - id: k8s-controller-VM
      min-number-of-instances: 1
      # max-number-of-instances: 10
    lcm-operations-configuration:
      operate-vnf-op-config:
        day1-2:
        - config-primitive:
          - name: deploy-k8s-controller
            execution-environment-ref: configure-controller
          id: k8s_cluster_vnfd
          execution-environment-list:
          - id: configure-controller
            external-connection-point-ref: vnf-controller-ext
            juju:
              charm: k8s_cluster_installer
              proxy: true
          config-access:
            ssh-access:
              default-user: controller
              required: true
          initial-config-primitive:
          - execution-environment-ref: configure-controller
            name: config
            parameter:
            - name: ssh-hostname
              value: <rw_mgmt_ip>
            - name: ssh-username
              value: controller
            - name: ssh-password
              value: olaadeus
            - name: entity
              value: controller
            seq: 1

  - id: worker-df
    instantiation-level:
    - id: worker-instantiation-level
      vdu-level:
      - vdu-id: k8s-worker-VM
        number-of-instances: 1
    vdu-profile:
    - id: k8s-worker-VM
      min-number-of-instances: 1
      # max-number-of-instances: 1
    lcm-operations-configuration:
      operate-vnf-op-config:
        day1-2:
        - config-primitive:
          - name: deploy-k8s-worker
            execution-environment-ref: configure-worker
          id: k8s_cluster_vnfd
          execution-environment-list:
          - id: configure-worker
            external-connection-point-ref: vnf-worker-ext
            juju:
              charm: k8s_cluster_installer
              proxy: true
          config-access:
            ssh-access:
              default-user: worker
              required: true
          initial-config-primitive:
          - execution-environment-ref: configure-worker
            name: config
            parameter:
            - name: ssh-hostname
              value: <rw_mgmt_ip>
            - name: ssh-username
              value: worker
            - name: ssh-password
              value: olaadeus
            - name: entity
              value: worker
            seq: 1
  - id: mgmt-df
    instantiation-level:
    - id: mgmt-instantiation-level
      vdu-level:
      - vdu-id: mgmt-VM
        number-of-instances: 1
    vdu-profile:
    - id: mgmt-VM
      min-number-of-instances: 1
      # max-number-of-instances: 1
  vdu:
  - id: mgmt-VM
    # cloud-init-file: cloud-init-controller.cfg
    name: mgmt-VM
    description: Management VDU
    sw-image-desc: "ubuntu-template"
    virtual-storage-desc:
    - k8s-controller-VM-storage
    virtual-compute-desc: k8s-worker-VM-compute
    int-cpd:
    - id: mgmt-int-out
      virtual-network-interface-requirement:
      - name: mgmt-out
        virtual-interface:
          type: PARAVIRT
    - id: mgmt-int-in
      int-virtual-link-desc: internal-vld
      virtual-network-interface-requirement:
      - name: mgmt-in
        virtual-interface:
          type: PARAVIRT
  - id: k8s-controller-VM
    cloud-init-file: cloud-init-controller.cfg
    name: k8s-controller-VM
    description: VMs for the Kubernetes' controller plane
    sw-image-desc: "clean-ubuntu"
    virtual-storage-desc:
    - k8s-controller-VM-storage
    virtual-compute-desc: k8s-controller-VM-compute
    int-cpd:
    - id: controller-int-out
      virtual-network-interface-requirement:
      - name: controller-out
        virtual-interface:
          type: PARAVIRT
    - id: controller-int-in
      int-virtual-link-desc: internal-vld
      virtual-network-interface-requirement:
      - name: controller-in
        virtual-interface:
          type: PARAVIRT
  - id: k8s-worker-VM
    cloud-init-file: cloud-init-worker.cfg
    name: k8s-worker-VM
    description: VMs for the Kubernetes' workers
    sw-image-desc: "clean-ubuntu"
    virtual-storage-desc:
    - k8s-worker-VM-storage
    virtual-compute-desc: k8s-worker-VM-compute
    int-cpd:
    - id: worker-int-out
      virtual-network-interface-requirement:
      - name: worker-out
        virtual-interface:
          type: PARAVIRT
    - id: worker-int-in
      int-virtual-link-desc: internal-vld
      virtual-network-interface-requirement:
      - name: worker-in
        virtual-interface:
          type: PARAVIRT
  ext-cpd:
  - id: vnf-controller-ext
    int-cpd:
      vdu-id: k8s-controller-VM
      cpd: controller-int-out
  - id: vnf-worker-ext
    int-cpd:
      vdu-id: k8s-worker-VM
      cpd: worker-int-out
  - id: mgmt-ext
    int-cpd:
      vdu-id: mgmt-VM
      cpd: mgmt-int-out
